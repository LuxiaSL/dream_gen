[Rainmeter]
Update=50
AccurateText=1
DynamicWindowSize=1
HardwareAcceleration=1
OnRefreshAction=[!CommandMeasure MeasureDaemonLauncher "Run"]

; ========================================
; METADATA
; ========================================
[Metadata]
Name=Dream Window
Author=Dream Gen Project
Information=AI-generated dream window with live status and autonomous daemon
Version=1.1.0
License=MIT

; ========================================
; VARIABLES
; ========================================
@Include=#@#Variables.inc

; ========================================
; DAEMON LAUNCHER
; ========================================

[MeasureDaemonLauncher]
Measure=Plugin
Plugin=RunCommand
Parameter=powershell.exe -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File "#@#Scripts\launch_daemon.ps1" -ProjectPath "#ProjectPath#"
State=Hide
OutputType=ANSI
FinishAction=[!Log "Daemon launcher finished"]
Timeout=30000

; ========================================
; MEASURES - File Monitoring
; ========================================

[MeasureCurrentFrame]
Measure=Plugin
Plugin=FileView
Path=#ProjectPath#\output
Pattern=current_frame.png
FinishAction=[!UpdateMeter CurrentImage][!UpdateMeter PreviousImage][!CommandMeasure ActionTimerCrossfade "Execute 1"]

[MeasureStatusFile]
Measure=Plugin
Plugin=WebParser
URL=file://#ProjectPath#\output\status.json
RegExp=(?siU)"frame_number": ([0-9]+).*"generation_time": ([0-9.]+).*"status": "([^"]+).*"current_mode": "([^"]+).*"current_prompt": "([^"]+).*"cache_size": ([0-9]+).*"uptime_hours": ([0-9.]+).*"daemon_status": "([^"]+).*"comfyui_status": "([^"]+).*"controller_status": "([^"]+).*"is_buffering": (true|false)
UpdateRate=20
DynamicVariables=1

[MeasureFrameNumber]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=1

[MeasureGenTime]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=2

[MeasureStatus]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=3

[MeasureMode]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=4

[MeasurePrompt]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=5

[MeasureCacheSize]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=6

[MeasureUptime]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=7

[MeasureDaemonStatus]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=8

[MeasureComfyUIStatus]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=9

[MeasureControllerStatus]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=10

[MeasureIsBuffering]
Measure=Plugin
Plugin=WebParser
URL=[MeasureStatusFile]
StringIndex=11

; ========================================
; CROSSFADE ANIMATION
; ========================================

[ActionTimerCrossfade]
Measure=Plugin
Plugin=ActionTimer
ActionList1=Repeat FadeOut,10,75 | FadeComplete
FadeOut=[!SetOption PreviousImage ImageAlpha "(Clamp(#CURRENTSECTION#-(255/75),0,255))"][!UpdateMeter PreviousImage][!SetOption CurrentImage ImageAlpha "(Clamp(#CURRENTSECTION#+(255/75),0,255))"][!UpdateMeter CurrentImage][!Redraw]
FadeComplete=[!SetOption PreviousImage ImageAlpha "0"][!SetOption CurrentImage ImageAlpha "255"][!UpdateMeter *][!Redraw]
DynamicVariables=1

; ========================================
; PULSING GLOW ANIMATION
; ========================================

[MeasurePulse]
Measure=Calc
Formula=(sin(6.28318*((#UpdateRate#/1000)/(#PulseSpeed#/1000))*Counter)+1)/2*255
DynamicVariables=1
UpdateDivider=1

; ========================================
; METERS - Background & Frame
; ========================================

[Background]
Meter=Shape
X=0
Y=0
Shape=Rectangle 0,0,#WidgetWidth#,#WidgetHeight#,8 | Fill Color #ColorBgDark# | StrokeWidth 0
AntiAlias=1

; ========================================
; HEADER
; ========================================

[HeaderText]
Meter=String
X=12
Y=6
FontFace=Consolas
FontSize=9
FontColor=#ColorCyanPrimary#
FontWeight=700
StringEffect=Shadow
FontEffectColor=0,0,0,180
Text=DREAM WINDOW
AntiAlias=1

; ========================================
; BORDER & CORNERS
; ========================================

[BorderOuter]
Meter=Shape
X=8
Y=32
Shape=Rectangle 0,0,#ViewportWidth#,#ViewportHeight#,0 | StrokeWidth 6 | Stroke Color #ColorCyanPrimary# | Fill Color 0,0,0,0
AntiAlias=1

[CornerTopLeft]
Meter=Shape
X=8
Y=32
Shape=Line 0,0,0,24 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary#
Shape2=Line 0,0,24,0 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary#
AntiAlias=1

[CornerTopRight]
Meter=Shape
X=(8+#ViewportWidth#)
Y=32
Shape=Line 0,0,0,24 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary#
Shape2=Line 0,0,-24,0 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary#
AntiAlias=1

[CornerBottomLeft]
Meter=Shape
X=8
Y=(32+#ViewportHeight#)
Shape=Line 0,0,0,-24 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary#
Shape2=Line 0,0,24,0 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary#
AntiAlias=1

[CornerBottomRight]
Meter=Shape
X=(8+#ViewportWidth#)
Y=(32+#ViewportHeight#)
Shape=Line 0,0,0,-24 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary#
Shape2=Line 0,0,-24,0 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary#
AntiAlias=1

; ========================================
; PULSING GLOW (Inner Border)
; ========================================

[InnerGlowDynamic]
Meter=Shape
X=11
Y=35
MeasureName=MeasurePulse
Shape=Rectangle 0,0,(#ViewportWidth#-6),(#ViewportHeight#-6),0 | StrokeWidth 2 | Stroke Color #ColorCyanSecondary#,[MeasurePulse] | Fill Color 0,0,0,0
AntiAlias=1
DynamicVariables=1

; ========================================
; IMAGE DISPLAY (Previous Frame)
; ========================================

[PreviousImage]
Meter=Image
X=11
Y=35
W=#ViewportWidth#
H=#ViewportHeight#
PreserveAspectRatio=1
ImageAlpha=0
ImageName=#ProjectPath#\output\current_frame.png
DynamicVariables=1

; ========================================
; IMAGE DISPLAY (Current Frame)
; ========================================

[CurrentImage]
Meter=Image
X=11
Y=35
W=#ViewportWidth#
H=#ViewportHeight#
PreserveAspectRatio=1
ImageAlpha=255
ImageName=#ProjectPath#\output\current_frame.png
DynamicVariables=1

; ========================================
; LOADING OVERLAY (Shows while buffering)
; ========================================

[LoadingOverlay]
Meter=Shape
MeasureName=MeasureIsBuffering
X=11
Y=35
Shape=Rectangle 0,0,#ViewportWidth#,#ViewportHeight# | Fill Color 0,0,0,200 | StrokeWidth 0
Hidden=(#CURRENTSECTION# = "false" ? 1 : 0)
DynamicVariables=1

[LoadingText]
Meter=String
MeasureName=MeasureComfyUIStatus
X=(11 + #ViewportWidth# / 2)
Y=(35 + #ViewportHeight# / 2 - 10)
FontFace=Consolas
FontSize=12
FontColor=#ColorCyanPrimary#
FontWeight=700
StringAlign=CenterCenter
StringEffect=Shadow
FontEffectColor=0,0,0,255
Text=(#CURRENTSECTION# = "starting" ? "STARTING COMFYUI..." : (#CURRENTSECTION# = "ready" ? "LOADING FRAMES..." : "INITIALIZING..."))
AntiAlias=1
Hidden=([MeasureIsBuffering] = "false" ? 1 : 0)
DynamicVariables=1

[LoadingSpinner]
Meter=Shape
X=(11 + #ViewportWidth# / 2)
Y=(35 + #ViewportHeight# / 2 + 20)
Shape=Ellipse 0,0,15 | StrokeWidth 3 | Stroke Color #ColorCyanPrimary# | Fill Color 0,0,0,0
Shape2=Ellipse 0,0,15,270,90 | StrokeWidth 3 | Stroke Color #ColorCyanSecondary# | Fill Color 0,0,0,0
TransformationMatrix=(Cos(Rad((#CURRENTSECTION# * 6) % 360)));(-Sin(Rad((#CURRENTSECTION# * 6) % 360)));(Sin(Rad((#CURRENTSECTION# * 6) % 360)));(Cos(Rad((#CURRENTSECTION# * 6) % 360)));[LoadingSpinner:X];[LoadingSpinner:Y]
AntiAlias=1
Hidden=([MeasureIsBuffering] = "false" ? 1 : 0)
DynamicVariables=1

; ========================================
; SCANLINES OVERLAY (Optional)
; ========================================

[Scanlines]
Meter=Image
X=11
Y=35
W=#ViewportWidth#
H=#ViewportHeight#
ImageName=#@#Images\scanlines.png
ImageAlpha=#ScanlinesAlpha#
Hidden=(1-#ScanlinesEnabled#)
DynamicVariables=1

; ========================================
; STATUS BAR
; ========================================

[StatusBackground]
Meter=Shape
X=8
Y=(32+#ViewportHeight#+8)
Shape=Rectangle 0,0,#ViewportWidth#,32,4 | Fill Color 0,0,0,180 | StrokeWidth 0
AntiAlias=1

[StatusTextFrame]
Meter=String
MeasureName=MeasureFrameNumber
X=16
Y=(32+#ViewportHeight#+12)
FontFace=Consolas
FontSize=8
FontColor=#ColorTextGray#
StringEffect=Shadow
FontEffectColor=0,0,0,200
Text=Frame #%1
AntiAlias=1
DynamicVariables=1

[StatusTextGenTime]
Meter=String
MeasureName=MeasureGenTime
X=90
Y=(32+#ViewportHeight#+12)
FontFace=Consolas
FontSize=8
FontColor=#ColorTextGray#
StringEffect=Shadow
FontEffectColor=0,0,0,200
Text=%1s
NumOfDecimals=2
AntiAlias=1
DynamicVariables=1

[StatusTextStatus]
Meter=String
MeasureName=MeasureStatus
X=150
Y=(32+#ViewportHeight#+12)
FontFace=Consolas
FontSize=8
FontColor=#ColorCyanPrimary#
StringEffect=Shadow
FontEffectColor=0,0,0,200
Text=%1
StringCase=Upper
AntiAlias=1
DynamicVariables=1

[StatusTextCache]
Meter=String
MeasureName=MeasureCacheSize
X=16
Y=(32+#ViewportHeight#+24)
FontFace=Consolas
FontSize=7
FontColor=#ColorTextGray#
StringEffect=Shadow
FontEffectColor=0,0,0,200
Text=Cache: %1
AntiAlias=1
DynamicVariables=1

[StatusTextUptime]
Meter=String
MeasureName=MeasureUptime
X=90
Y=(32+#ViewportHeight#+24)
FontFace=Consolas
FontSize=7
FontColor=#ColorTextGray#
StringEffect=Shadow
FontEffectColor=0,0,0,200
Text=Up: %1h
NumOfDecimals=1
AntiAlias=1
DynamicVariables=1

[StatusTextMode]
Meter=String
MeasureName=MeasureMode
X=150
Y=(32+#ViewportHeight#+24)
FontFace=Consolas
FontSize=7
FontColor=#ColorTextGray#
StringEffect=Shadow
FontEffectColor=0,0,0,200
Text=%1
AntiAlias=1
DynamicVariables=1

; ========================================
; DAEMON STATUS INDICATOR (Optional)
; ========================================

[DaemonStatusDot]
Meter=Shape
MeasureName=MeasureDaemonStatus
X=240
Y=10
Shape=Ellipse 0,0,4 | Fill Color #ColorDaemonStatus# | StrokeWidth 0
AntiAlias=1
DynamicVariables=1

[ColorDaemonStatus]
; Dynamically set based on daemon_status
; Green=ready, Yellow=starting, Red=error
Formula=(#CURRENTSECTION# = "running" ? 0x00FF00 : (#CURRENTSECTION# = "starting" ? 0xFFFF00 : 0xFF0000))

